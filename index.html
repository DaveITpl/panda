<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Generator Etykiet</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
      .label {
          width: 6in;
          height: 4in;
          border: 1px solid #000;
          position: relative;
          box-sizing: border-box;
          display: grid;
          grid-template-columns: 1in 1fr 1in;
          background: white;
      }
      .left-text {
          transform: translateY(-51%) translateX(12%) rotate(90deg);
          transform-origin: left center;
          font-size: 0.4in;
          color: white;
          background: #000;
          width: 4in;
          height: 1in;
          display: grid;
          align-items: center;
          justify-content: center;
      }
      .center-content {
          text-align: center;
          display: grid;
          grid-template-rows: 1fr auto;
          gap:0;
          height: 100%;
      }
      .flavor-container {
          display: grid;
          align-items: center;
          justify-content: center;
          margin-bottom: 0.3in;
      }
      .logo {
          display: grid;
          align-items: center;
          justify-content: center;
      }
      .center-content img.logo {
          width: 3in;
          height: auto;
          max-height: 2in;
      }
      .flavor {
          margin-top: 0.1in;
          font-size: 0.4in;
          font-weight: bold;
      }
      .right-text {
          transform: translateY(-53%) translateX(-88%) rotate(-90deg);
          transform-origin: right center;
          font-size: 0.15in;
          text-align: center;
          display: grid;
          grid-template-columns: auto 1fr;
          align-items: center;
          height: 1.4in;
          width: 4in;
      }
      #barcode {
          margin-bottom: 0.2in;
      }
      #expiry, #batch { font-weight: bold;}
      .right-text-content {
          display: grid;
          align-items: center;
          justify-content: center;
          font-size: 0.18in;
          margin-left: -13px;
      }
      .label-preview {
          border: 2px dashed #dee2e6;
          padding: 20px;
          margin: 20px 0;
          background: #f8f9fa;
      }
      .form-section {
          background: white;
          border-radius: 8px;
          padding: 20px;
          margin-bottom: 20px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
  </style>
</head>
<body class="bg-light">

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <h1 class="text-center mb-4">Generator Etykiet 6x4"</h1>
    </div>
  </div>

  <div class="row">
    <!-- Formularz -->
    <div class="col-lg-4">
      <div class="form-section">
        <h3 class="h5 mb-3">Konfiguracja Etykiety</h3>

        <form id="form">
          <div class="mb-3">
            <label for="brand-select" class="form-label">Marka produktu</label>
            <select class="form-select" id="brand-select">
              <option value="">Wybierz markę...</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="product-select" class="form-label">Produkt</label>
            <select class="form-select" id="product-select" disabled>
              <option value="">Najpierw wybierz markę...</option>
            </select>
          </div>

          <div class="row">
            <div class="col-6">
              <div class="mb-3">
                <label for="expiry-input" class="form-label">Data ważności</label>
                <input type="text" class="form-control" id="expiry-input" value="06/2027">
              </div>
            </div>
            <div class="col-6">
              <div class="mb-3">
                <label for="batch-input" class="form-label">Nr partii</label>
                <input type="text" class="form-control" id="batch-input" value="5/2025">
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Informacje automatyczne:</label>
            <div class="row">
              <div class="col-4">
                <small class="text-muted">Typ: <span id="product-type-display">-</span></small>
              </div>
              <div class="col-4">
                <small class="text-muted">Kod: <span id="barcode-display">-</span></small>
              </div>
              <div class="col-4">
                <small class="text-muted">Smaki: <span id="flavors-display">-</span></small>
              </div>
            </div>
          </div>

        </form>
      </div>

      <div class="form-section">
        <h3 class="h5 mb-3">Akcje</h3>
        <div class="d-grid gap-2">
          <button class="btn btn-success" onclick="downloadLabel()">
            <i class="bi bi-download"></i> Pobierz jako PNG
          </button>
          <button class="btn btn-info" onclick="printLabelPNG()">
            <i class="bi bi-printer"></i> Drukuj etykietę
          </button>
        </div>
      </div>
    </div>

    <!-- Podgląd etykiety -->
    <div class="col-lg-8">
      <div class="label-preview">
        <h3 class="h5 mb-3">Podgląd etykiety</h3>
        <div class="d-flex justify-content-center">
          <div class="label" id="label">
            <div class="left-text" id="left-text">WYBIERZ PRODUKT</div>
            <div class="center-content">
              <div class="logo">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y4ZjlmYSIgc3Ryb2tlPSIjZGVlMmU2IiBzdHJva2Utd2lkdGg9IjIiLz4KICA8dGV4dCB4PSIxMDAiIHk9IjEwNSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2IiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5MT0dPPC90ZXh0Pgo8L3N2Zz4=" alt="Logo" class="logo">
              </div>
              <div class="flavor-container">
                <div class="flavor" id="flavor-line1">ZIELONY BANAN</div>
                <div class="flavor" id="flavor-line2">WINOGRONO</div>
              </div>
            </div>
            <div class="right-text">
              <div>
                <svg id="barcode"></svg>
              </div>
              <div class="right-text-content">
                <div>Data ważności: <span id="expiry">06/2027</span></div>
                <div>Nr partii: <span id="batch">5/2025</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="./products-config.js"></script>
<script>

    // Inicjalizacja formularza
    function initializeForm() {
        // Automatyczne ustawienie daty ważności (2 lata w przód) i partii (aktualny miesiąc/rok)
        setDefaultDates();

        const brandSelect = document.getElementById('brand-select');
        const productSelect = document.getElementById('product-select');
        const expiryInput = document.getElementById('expiry-input');
        const batchInput = document.getElementById('batch-input');

        // Wypełnienie listy marek
        Object.keys(productsData).forEach(brand => {
            const option = document.createElement('option');
            option.value = brand;
            option.textContent = brand;
            brandSelect.appendChild(option);
        });

        // Obsługa zmiany marki
        brandSelect.addEventListener('change', function() {
            const selectedBrand = this.value;
            productSelect.innerHTML = '<option value="">Wybierz produkt...</option>';

            if (selectedBrand && productsData[selectedBrand]) {
                productSelect.disabled = false;
                Object.keys(productsData[selectedBrand].products).forEach(productName => {
                    const option = document.createElement('option');
                    option.value = productName;
                    option.textContent = productName;
                    productSelect.appendChild(option);
                });
            } else {
                productSelect.disabled = true;
            }

            // Reset informacji o produkcie
            document.getElementById('product-type-display').textContent = '-';
            document.getElementById('barcode-display').textContent = '-';
            document.getElementById('flavors-display').textContent = '-';

            // Automatyczna aktualizacja etykiety
            updateLabel();
        });

        // Obsługa zmiany produktu
        productSelect.addEventListener('change', function() {
            const selectedBrand = brandSelect.value;
            const selectedProduct = this.value;

            if (selectedBrand && selectedProduct && productsData[selectedBrand]) {
                const productData = productsData[selectedBrand].products[selectedProduct];
                if (productData) {
                    const typeText = productData.type === 'S' ? 'SÓL NIKOTYNOWA' : 'LONGFILL';
                    document.getElementById('product-type-display').textContent = typeText;
                    document.getElementById('barcode-display').textContent = productData.barcode;
                    document.getElementById('flavors-display').textContent = `${productData.flavor1} / ${productData.flavor2}`;
                }
            }

            // Automatyczna aktualizacja etykiety
            updateLabel();
        });

        // Automatyczna aktualizacja przy zmianie daty ważności
        expiryInput.addEventListener('input', function() {
            document.getElementById("expiry").textContent = this.value;
        });

        // Automatyczna aktualizacja przy zmianie numeru partii
        batchInput.addEventListener('input', function() {
            document.getElementById("batch").textContent = this.value;
        });
    }

    function setDefaultDates() {
        const now = new Date();
        const currentMonth = now.getMonth() + 1; // getMonth() zwraca 0-11, więc dodajemy 1
        const currentYear = now.getFullYear();

        // Data ważności: 2 lata w przód, format MM/YYYY
        const expiryYear = currentYear + 2;
        const expiryDate = String(currentMonth).padStart(2, '0') + '/' + expiryYear;

        // Numer partii: aktualny miesiąc/rok, format M/YYYY
        const batchNumber = currentMonth + '/' + currentYear;

        // Ustawienie wartości w inputach
        document.getElementById('expiry-input').value = expiryDate;
        document.getElementById('batch-input').value = batchNumber;

        // Aktualizacja etykiety
        document.getElementById("expiry").textContent = expiryDate;
        document.getElementById("batch").textContent = batchNumber;
    }

    function generateBarcode(number) {
        const barcodeEl = document.getElementById("barcode");
        barcodeEl.innerHTML = '';
        if (number && number.length > 0) {
            try{
                JsBarcode(barcodeEl, number, {
                    format: "EAN13",
                    displayValue: true,
                    fontSize: 14,
                    height: 75,
                    width: 1.5
                });
            } catch (e) {
                generateBarcode('')
                console.log("NIEPRAWIDŁOWY KOD")
                alert("NIEPRAWIDŁOWY KOD PRODUKTU")
            }
        }
    }

    function updateLabel() {
        const selectedBrand = document.getElementById('brand-select').value;
        const selectedProduct = document.getElementById('product-select').value;

        if (!selectedBrand) {
            // Reset do stanu początkowego
            document.querySelector(".logo img").src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y4ZjlmYSIgc3Ryb2tlPSIjZGVlMmU2IiBzdHJva2Utd2lkdGg9IjIiLz4KICA8dGV4dCB4PSIxMDAiIHk9IjEwNSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2IiBmaWxsPSIjNmM3NTdkIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5MT0dPPC90ZXh0Pgo8L3N2Zz4=";
            document.getElementById("left-text").textContent = "WYBIERZ PRODUKT";
            document.getElementById("flavor-line1").textContent = "SMAK 1";
            document.getElementById("flavor-line2").textContent = "SMAK 2";
            generateBarcode('');
            return;
        }

        if (!selectedProduct) {
            // Pokaż tylko logo marki
            const brandData = productsData[selectedBrand];
            document.querySelector(".logo img").src = brandData.logo;
            document.getElementById("left-text").textContent = "WYBIERZ PRODUKT";
            document.getElementById("flavor-line1").textContent = "SMAK 1";
            document.getElementById("flavor-line2").textContent = "SMAK 2";
            generateBarcode('');
            return;
        }

        const brandData = productsData[selectedBrand];
        const productData = brandData.products[selectedProduct];

        // Aktualizacja logo
        document.querySelector(".logo img").src = brandData.logo;

        // Aktualizacja typu produktu (lewa strona)
        const typeText = productData.type === 'S' ? 'SÓL NIKOTYNOWA' : 'LONGFILL';
        document.getElementById("left-text").textContent = typeText;

        // Aktualizacja smaków
        document.getElementById("flavor-line1").textContent = productData.flavor1;
        document.getElementById("flavor-line2").textContent = productData.flavor2;

        // Aktualizacja daty i partii
        document.getElementById("expiry").textContent = document.getElementById("expiry-input").value;
        document.getElementById("batch").textContent = document.getElementById("batch-input").value;

        // Generowanie kodu kreskowego
        generateBarcode(productData.barcode);
    }

    function downloadLabel() {
        const selectedBrand = document.getElementById('brand-select').value;
        const selectedProduct = document.getElementById('product-select').value;

        if (!selectedBrand || !selectedProduct) {
            alert('Proszę wybrać markę i produkt przed pobraniem');
            return;
        }

        const label = document.getElementById("label");
        html2canvas(label, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            const productData = productsData[selectedBrand].products[selectedProduct];
            link.download = `${selectedBrand}_${selectedProduct.replace(/\s+/g, '_')}_${productData.barcode}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function printLabelPNG() {
        const selectedBrand = document.getElementById('brand-select').value;
        const selectedProduct = document.getElementById('product-select').value;

        if (!selectedBrand || !selectedProduct) {
            alert('Proszę wybrać markę i produkt przed drukowaniem');
            return;
        }

        const label = document.getElementById("label");
        html2canvas(label, { scale: 2 }).then( async (canvas) => {
            const dataUrl = await canvas.toDataURL("image/png");

            const win = await window.open('', 'PRINT', 'height=800,width=800');
            await win.document.write(`
            <html>
            <head>
              <title>Etykieta - ${selectedBrand} ${selectedProduct}</title>
              <style>
                body { margin:0; text-align:center; }
                img { max-width:100%; }
              </style>
            </head>
            <body>
              <img src="${dataUrl}" alt="Etykieta">
            </body>
            </html>
        `);
            // win.document.close();
            await win.focus();
            await win.print();
        });
    }

    // Inicjalizacja po załadowaniu strony
    document.addEventListener('DOMContentLoaded', function() {
        initializeForm();
        // Generuj pusty kod kreskowy na start
        generateBarcode('');
    });
</script>

</body>
</html>